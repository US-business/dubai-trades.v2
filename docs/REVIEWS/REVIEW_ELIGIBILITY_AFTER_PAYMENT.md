# ุฃูููุฉ ุงูุชูููู ุจุนุฏ ุงูุฏูุน ูุงูุชุณููู

## ุงููุดููุฉ ุงูููุชุดูุฉ ๐จ

ุชู ุงูุชุดุงู **ุนุฏู ุชุทุงุจู** ูู ูุธุงู ุงูุชููููุงุช ูููุน ุงูุนููุงุก ูู ูุชุงุจุฉ ุงูุชููููุงุช ุญุชู ุจุนุฏ ุงูุฏูุน ูุงูุชุณููู.

### ุงููุดููุฉ ุงูุฃุตููุฉ โ
```typescript
// ูู checkPurchaseVerification (ูุฏูู)
eq(orders.status, "completed") // ูุจุญุซ ุนู ุญุงูุฉ ุบูุฑ ููุฌูุฏุฉ!
```

### ุงูุญู ุงููุทุจู โ
```typescript
// ูู checkPurchaseVerification (ุฌุฏูุฏ)
and(
    eq(orders.status, "delivered"),  // ุชู ุงูุชุณููู
    eq(orders.paymentStatus, "paid") // ุชู ุงูุฏูุน
)
```

## ุงูุดุฑูุท ุงูุฌุฏูุฏุฉ ููุชูููู ๐

ููู ูุชููู ุงูุนููู ูู ูุชุงุจุฉ ุชููููุ ูุฌุจ:

1. **ุชุณุฌูู ุงูุฏุฎูู** โ
2. **ุดุฑุงุก ุงูููุชุฌ** (ุทูุจ ููุฌูุฏ) โ  
3. **ุชุณููู ุงูุทูุจ** (`orders.status = "delivered"`) โ
4. **ุชุฃููุฏ ุงูุฏูุน** (`orders.paymentStatus = "paid"`) โ
5. **ุนุฏู ูุฌูุฏ ุชูููู ุณุงุจู** โ

## ุงูุณููุงุฑูู ุงููุงูู ููุฏูุน ุนูุฏ ุงูุงุณุชูุงู ๐

### ุงููุฑุงุญู:
```
1. ุงูุนููู ูุทูุจ ููุชุฌ โ COD
   ๐ฆ Order: "pending" 
   ๐ฐ Payment: "pending"
   ๐ Review: โ ุบูุฑ ูุณููุญ

2. ุชุฃููุฏ ููุนุงูุฌุฉ ุงูุทูุจ
   ๐ฆ Order: "processing"
   ๐ฐ Payment: "pending" 
   ๐ Review: โ ุบูุฑ ูุณููุญ

3. ุดุญู ุงูุทูุจ
   ๐ฆ Order: "shipped"
   ๐ฐ Payment: "pending"
   ๐ Review: โ ุบูุฑ ูุณููุญ

4. ุชุณููู ุงูุทูุจ ููุนููู
   ๐ฆ Order: "delivered"
   ๐ฐ Payment: "pending"
   ๐ Review: โ ุบูุฑ ูุณููุญ (ุงูุฏูุน ูุนูู)

5. ุงูุนููู ูุฏูุน ุงููุจูุบ
   ๐ฆ Order: "delivered"
   ๐ฐ Payment: "paid"
   ๐ Review: โ ูุณููุญ ุงูุขู!
```

## ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ๐งช

### ุงุณุชุฎุฏุงู ุณูุฑูุจุช ุงูุงุฎุชุจุงุฑ:
```bash
npx tsx scripts/test-review-eligibility-after-payment.ts
```

### ูุง ูุฎุชุจุฑู ุงูุณูุฑูุจุช:
1. ุงูุญุงูุฉ ุงูุฃูููุฉ ููุชูููู
2. ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู "delivered" 
3. ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน ุฅูู "paid"
4. ุงูุชุญูู ูู ุงูุฃูููุฉ ุงูููุงุฆูุฉ

## ุฌุฏูู ุงูุญุงูุงุช ๐

| ุญุงูุฉ ุงูุทูุจ | ุญุงูุฉ ุงูุฏูุน | ุฃูููุฉ ุงูุชูููู | ุงูุณุจุจ |
|------------|------------|--------------|-------|
| pending    | pending    | โ           | ูู ูุชู ุงูุชุณููู |
| processing | pending    | โ           | ูู ูุชู ุงูุชุณููู |
| shipped    | pending    | โ           | ูู ูุชู ุงูุชุณููู |
| shipped    | paid       | โ           | ูู ูุชู ุงูุชุณููู |
| delivered  | pending    | โ           | ูู ูุชู ุงูุฏูุน |
| delivered  | failed     | โ           | ูุดู ุงูุฏูุน |
| **delivered** | **paid** | **โ**       | **ูุคูู ููุชูููู** |

## ุงูุชุญุฏูุซุงุช ุงููุทุจูุฉ ๐ง

### 1. ุชุญุฏูุซ `checkPurchaseVerification`:
```typescript
// ุงูุดุฑูุท ุงูุฌุฏูุฏุฉ
and(
    eq(orders.userId, userId),
    eq(orderItems.productId, productId),
    eq(orders.status, "delivered"),      // โ ุชู ุงูุชุณููู
    eq(orders.paymentStatus, "paid")     // โ ุชู ุงูุฏูุน
)
```

### 2. ุฅุถุงูุฉ ูููู ุฅุฏุงุฑุฉ ุงูุฏูุน:
- `UpdatePaymentStatus.tsx` - ูุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน ูู ููุญุฉ ุงูุชุญูู
- ููุงุนุฏ ุฐููุฉ ููุฏูุน ุนูุฏ ุงูุงุณุชูุงู
- ููุน ุชุญุฏูุซ ุงูุฏูุน ูุจู ุงูุชุณููู

### 3. ุณูุฑูุจุช ุงุฎุชุจุงุฑ ุดุงูู:
- `test-review-eligibility-after-payment.ts`
- ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุงููุงูู
- ุงุฎุชุจุงุฑ ุญุงูุงุช ูุฎุชููุฉ

## ุฑุณุงุฆู ุงููุธุงู ููุนููู ๐ฌ

### ุญุงูุงุช ูุฎุชููุฉ:

**ุบูุฑ ูุณุฌู ุฏุฎูู:**
```
โ "You must be logged in to write a review"
```

**ูู ูุดุชุฑ ุงูููุชุฌ:**
```
โ "ูุฌุจ ุนููู ุดุฑุงุก ูุฐุง ุงูููุชุฌ ูุจู ุฃู ุชุชููู ูู ูุชุงุจุฉ ุชูููู ูู"
โ "You must purchase this product before you can write a review"
```

**ุชู ุงูุดุฑุงุก ูุงูุชุณููู ูุงูุฏูุน:**
```
โ "You can write a review for this product"
```

**ุชู ุงูุชูููู ูู ูุจู:**
```
โ "You have already reviewed this product"
```

## ูููุทูุฑูู ๐จโ๐ป

### ูุตุงุฆุญ ูููุฉ:
1. **ุงุณุชุฎุฏู ุงูุณูุฑูุจุช** ูุงุฎุชุจุงุฑ ุงูุณููุงุฑูููุงุช
2. **ุชุฃูุฏ ูู ุงูุญุงูุงุช** ูุจู ุนุฑุถ ูููุฐุฌ ุงูุชูููู
3. **ุฑุงูุจ ุงูุฃุฎุทุงุก** ูู console ูุชุดุฎูุต ุงููุดุงูู
4. **ุงุฎุชุจุฑ ูุน ูุณุชุฎุฏููู ุญูููููู** ุจุนุฏ ุงููุดุฑ

### ููุฏ ูููุฏ ููุชุทููุฑ:
```typescript
// ุงูุชุญูู ูู ุงูุฃูููุฉ ูุจู ุนุฑุถ ุงููููุฐุฌ
const eligibility = await canUserWriteReview(productId)
if (eligibility.success && eligibility.data?.canWrite) {
    // ุนุฑุถ ูููุฐุฌ ุงูุชูููู
} else {
    // ุนุฑุถ ุฑุณุงูุฉ ุชูุถูุญูุฉ
}
```

## ุงูุฎูุงุตุฉ โจ

ุงูุขู ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ! ุงูุนููุงุก ูููููู ูุชุงุจุฉ ุงูุชููููุงุช **ููุท** ุจุนุฏ:
- โ ุงูุชุณููู ุงููุนูู ููุทูุจ
- โ ุชุฃููุฏ ุงูุฏูุน (ุญุชู ูู ูุงู ุนูุฏ ุงูุงุณุชูุงู)

ูุฐุง ูุถูู ูุตุฏุงููุฉ ุงูุชููููุงุช ููููุน ุงูุชูุงุนุจ.
